name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  lint-type:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            Makefile
      - name: Cache mypy results
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: ${{ runner.os }}-mypy-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-mypy-
      - name: Install lint and type check dependencies
        run: |
          python -m pip install --upgrade pip uv
          uv pip install --system --group lint --group typecheck
      - name: Black
        run: black --check .
      - name: Isort
        run: isort --check-only .
      - name: Flake8
        run: flake8 .
      - name: Mypy
        run: mypy

  hassfest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: home-assistant/actions/hassfest@master

  hacs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: HACS validation
        uses: hacs/action@main
        continue-on-error: true  # Brands validation fails for custom integrations (expected)
        with:
          category: integration
          # Repository topics configured: home-assistant, hacs, homeassistant-integration, zigbee, ubisys, custom-component
          # Note: Brands validation will fail (expected for custom integrations)

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip uv
          uv pip install --system --group test
      - name: Run tests with coverage
        run: pytest --cov=custom_components/ubisys --cov-report=term-missing
